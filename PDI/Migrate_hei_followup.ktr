<?xml version="1.0" encoding="UTF-8"?>
<transformation>
  <info>
    <name>Migrate_hei_followup</name>
    <description/>
    <extended_description/>
    <trans_version/>
    <trans_type>Normal</trans_type>
    <trans_status>0</trans_status>
    <directory>/</directory>
    <parameters>
    </parameters>
    <log>
      <trans-log-table>
        <connection/>
        <schema/>
        <table/>
        <size_limit_lines/>
        <interval/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STATUS</id>
          <enabled>Y</enabled>
          <name>STATUS</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
          <subject/>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
          <subject/>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
          <subject/>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
          <subject/>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
          <subject/>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
          <subject/>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>STARTDATE</id>
          <enabled>Y</enabled>
          <name>STARTDATE</name>
        </field>
        <field>
          <id>ENDDATE</id>
          <enabled>Y</enabled>
          <name>ENDDATE</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>DEPDATE</id>
          <enabled>Y</enabled>
          <name>DEPDATE</name>
        </field>
        <field>
          <id>REPLAYDATE</id>
          <enabled>Y</enabled>
          <name>REPLAYDATE</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>Y</enabled>
          <name>LOG_FIELD</name>
        </field>
        <field>
          <id>EXECUTING_SERVER</id>
          <enabled>N</enabled>
          <name>EXECUTING_SERVER</name>
        </field>
        <field>
          <id>EXECUTING_USER</id>
          <enabled>N</enabled>
          <name>EXECUTING_USER</name>
        </field>
        <field>
          <id>CLIENT</id>
          <enabled>N</enabled>
          <name>CLIENT</name>
        </field>
      </trans-log-table>
      <perf-log-table>
        <connection/>
        <schema/>
        <table/>
        <interval/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>SEQ_NR</id>
          <enabled>Y</enabled>
          <name>SEQ_NR</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>INPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>INPUT_BUFFER_ROWS</name>
        </field>
        <field>
          <id>OUTPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>OUTPUT_BUFFER_ROWS</name>
        </field>
      </perf-log-table>
      <channel-log-table>
        <connection/>
        <schema/>
        <table/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>LOGGING_OBJECT_TYPE</id>
          <enabled>Y</enabled>
          <name>LOGGING_OBJECT_TYPE</name>
        </field>
        <field>
          <id>OBJECT_NAME</id>
          <enabled>Y</enabled>
          <name>OBJECT_NAME</name>
        </field>
        <field>
          <id>OBJECT_COPY</id>
          <enabled>Y</enabled>
          <name>OBJECT_COPY</name>
        </field>
        <field>
          <id>REPOSITORY_DIRECTORY</id>
          <enabled>Y</enabled>
          <name>REPOSITORY_DIRECTORY</name>
        </field>
        <field>
          <id>FILENAME</id>
          <enabled>Y</enabled>
          <name>FILENAME</name>
        </field>
        <field>
          <id>OBJECT_ID</id>
          <enabled>Y</enabled>
          <name>OBJECT_ID</name>
        </field>
        <field>
          <id>OBJECT_REVISION</id>
          <enabled>Y</enabled>
          <name>OBJECT_REVISION</name>
        </field>
        <field>
          <id>PARENT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>PARENT_CHANNEL_ID</name>
        </field>
        <field>
          <id>ROOT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>ROOT_CHANNEL_ID</name>
        </field>
      </channel-log-table>
      <step-log-table>
        <connection/>
        <schema/>
        <table/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>N</enabled>
          <name>LOG_FIELD</name>
        </field>
      </step-log-table>
      <metrics-log-table>
        <connection/>
        <schema/>
        <table/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>METRICS_DATE</id>
          <enabled>Y</enabled>
          <name>METRICS_DATE</name>
        </field>
        <field>
          <id>METRICS_CODE</id>
          <enabled>Y</enabled>
          <name>METRICS_CODE</name>
        </field>
        <field>
          <id>METRICS_DESCRIPTION</id>
          <enabled>Y</enabled>
          <name>METRICS_DESCRIPTION</name>
        </field>
        <field>
          <id>METRICS_SUBJECT</id>
          <enabled>Y</enabled>
          <name>METRICS_SUBJECT</name>
        </field>
        <field>
          <id>METRICS_TYPE</id>
          <enabled>Y</enabled>
          <name>METRICS_TYPE</name>
        </field>
        <field>
          <id>METRICS_VALUE</id>
          <enabled>Y</enabled>
          <name>METRICS_VALUE</name>
        </field>
      </metrics-log-table>
    </log>
    <maxdate>
      <connection/>
      <table/>
      <field/>
      <offset>0.0</offset>
      <maxdiff>0.0</maxdiff>
    </maxdate>
    <size_rowset>10000</size_rowset>
    <sleep_time_empty>50</sleep_time_empty>
    <sleep_time_full>50</sleep_time_full>
    <unique_connections>N</unique_connections>
    <feedback_shown>Y</feedback_shown>
    <feedback_size>50000</feedback_size>
    <using_thread_priorities>Y</using_thread_priorities>
    <shared_objects_file/>
    <capture_step_performance>N</capture_step_performance>
    <step_performance_capturing_delay>1000</step_performance_capturing_delay>
    <step_performance_capturing_size_limit>100</step_performance_capturing_size_limit>
    <dependencies>
    </dependencies>
    <partitionschemas>
    </partitionschemas>
    <slaveservers>
    </slaveservers>
    <clusterschemas>
    </clusterschemas>
    <created_user>-</created_user>
    <created_date>2020/01/22 16:06:05.516</created_date>
    <modified_user>-</modified_user>
    <modified_date>2020/01/22 16:06:05.516</modified_date>
    <key_for_session_key>H4sIAAAAAAAAAAMAAAAAAAAAAAA=</key_for_session_key>
    <is_key_private>N</is_key_private>
  </info>
  <notepads>
  </notepads>
  <connection>
    <name>mssql</name>
    <server/>
    <type>MSSQLNATIVE</type>
    <access>JNDI</access>
    <database>mssql</database>
    <port>1521</port>
    <username/>
    <password>Encrypted </password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>MSSQL_DOUBLE_DECIMAL_SEPARATOR</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>1521</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <connection>
    <name>mysql_st</name>
    <server/>
    <type>MYSQL</type>
    <access>JNDI</access>
    <database>mysql_st</database>
    <port>1521</port>
    <username/>
    <password>Encrypted </password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>1521</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>STREAM_RESULTS</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <order>
    <hop>
      <from>Create_st_hei_followup</from>
      <to>iqcare_source_hei_followup</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>iqcare_source_hei_followup</from>
      <to>load_st_hei_followup</to>
      <enabled>Y</enabled>
    </hop>
  </order>
  <step>
    <name>Create_st_hei_followup</name>
    <type>ExecSQL</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>mysql_st</connection>
    <execute_each_row>N</execute_each_row>
    <single_statement>N</single_statement>
    <replace_variables>N</replace_variables>
    <quoteString>N</quoteString>
    <sql>-- 25. HEI Followup

DROP TABLE IF EXISTS migration_st.st_hei_followup;
CREATE TABLE migration_st.st_hei_followup (
  Person_Id                        			INT(11),
  Patient_clinic_number                     VARCHAR(100),
  Encounter_Date                  		    DATE,
  Encounter_ID                              VARCHAR(50),
  Weight                                    DOUBLE,
  Height                                    DOUBLE,
  Primary_care_give			      	    	TEXT,
  Infant_feeding                            TEXT,
  TB_Assessment_Outcome				        TEXT,
  Social_smile_milestone_Under_2Months      TEXT,
  Social_smile_milestone_2Months            TEXT,
  Head_control_milestone_3Months            TEXT,
  Head_control_milestone_4Months            TEXT,
  Hand_extension_milestone_9months          TEXT,
  Sitting_milestone_12months                TEXT,
  Standing_milestone_15months               TEXT,
  Walking_milestone_18months                TEXT,
  Talking_milestone_36months                TEXT,
  First_DNA_PCRSampleDate                   DATE,
  First_DNA_PCRResult                       TEXT,
  First_DNA_PCRResultDate                   DATE,
  Second_DNA_PCRSampleDate                  DATE,
  Second_DNA_PCRResult                      TEXT,
  Second_DNA_PCRResultDate                  DATE,
  Third_DNA_PCRSampleDate                   DATE,
  Third_DNA_PCRResult                       TEXT,
  Third_DNA_PCRResultDate                   DATE,
  ConfimatoryPCR_SampleDate                 DATE,
  ConfirmatoryPCR_Result                    TEXT,
  ConfimatoryPCR_ResultDate                 DATE,
  RepeatConfirmatoryPCR_SampleDate          DATE,
  RepeatConfirmatoryPCR_Result              TEXT,
  RepeatConfirmatoryPCR_ResultDate          DATE,
  BaselineViralLoadSampleDate               DATE,
  BaselineViralLoadResult                   TEXT,
  BaselineViralLoadResultDate               DATE,
  Final_AntibodySampleDate                  DATE,
  Final_AntibodyResult                      TEXT,
  Final_AntibodyResultDate                  DATE,
  -- Review_of_systems_developmental        VARCHAR(100),
  ARV_prophylaxis_received                  TEXT,
  ARV_prophylaxis_Other_received            TEXT,
  Dna_pcr_sample_date                       DATE,
  Dna_pcr_contextual_status                 TEXT,
  Dna_pcr_results                           TEXT,
  Dna_pcr_dbs_sample_code                   TEXT,
  Dna_pcr_results_date                      DATE,
  Azt_given                                 TEXT,
  Nvp_given                                 TEXT,
  Ctx_given                                 TEXT,
  First_antibody_sample_date                DATE,
  First_antibody_result                     TEXT,
  First_antibody_dbs_sample_code            TEXT,
  First_antibody_result_date                DATE,
  Final_antibody_sample_date                DATE,
  Final_antibody_result                     TEXT,
  Final_antibody_dbs_sample_code            TEXT,
  Final_antibody_result_date                DATE,
  Tetracycline_Eye_Ointment  	            TEXT,
  Pupil 						            TEXT,
  Sight              				    	TEXT,
  Squint				                    TEXT,
  Deworming_Drug                            TEXT,
  Deworming_Dosage_Units                    TEXT,
  Date_of_next_appointment                  DATE,
  Comments                                  TEXT,
  CreatedBy                                 INT(11),
  CreateDate                                DATE,
  Voided                                    INT(11)
);
</sql>
    <set_params>N</set_params>
    <insert_field/>
    <update_field/>
    <delete_field/>
    <read_field/>
    <arguments>
    </arguments>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>112</xloc>
      <yloc>96</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>iqcare_source_hei_followup</name>
    <type>TableInput</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>mssql</connection>
    <sql>	
	---- 25. HEI Followup Validated by DNG
SELECT  
 p.PersonId as Person_Id,
 (SELECT TOP 1 PatientClinicID FROM mst_Patient MSP WHERE MSP.Ptn_Pk = p.ptn_pk) AS Patient_clinic_number,
 pen.VisitDate as Encounter_Date,
 NULL as Encounter_ID,
he.BirthWeight as [Weight],
 pvs.Height as  [Height],
 (select lt.[Name]  from LookupItem lt where lt.Id=he.PrimaryCareGiverID) as Primary_Care_Give,
hf.InfantFeeding as Infant_Feeding,
tbs.ScreeningValue as TB_Assessment_Outcome,

m.[Social_smile_milestone_&lt;2Months] as Social_smile_milestone_Under_2Months,
m.Social_smile_milestone_2Months as Social_smile_milestone_2Months,
m.Head_control_milestone_3Months,
m.Head_control_milestone_4Months,
m.Hand_extension_milestone_9months,
m.Sitting_milestone_12months,
m.Standing_milestone_15months,
m.Walking_milestone_18months,
m.Talking_milestone_36months,
rlabs.[1st_DNA_PCRSampleDate] as First_DNA_PCRSampleDate,
rlabs.[1st_DNA_PCRResult] as First_DNA_PCRResult,
rlabs.[1st_DNA_PCRResultDate] as First_DNA_PCRResultDate,
rlabs.[2nd_DNA_PCRSampleDate] as Second_DNA_PCRSampleDate,
rlabs.[2nd_DNA_PCRResult] as Second_DNA_PCRResult,
rlabs.[2nd_DNA_PCRResultDate] as Second_DNA_PCRResultDate,
rlabs.[3rd_DNA_PCRSampleDate] as Third_DNA_PCRSampleDate,
rlabs.[3rd_DNA_PCRResult] as Third_DNA_PCRResult,
rlabs.[3rd_DNA_PCRResultDate] as Third_DNA_PCRResultDate,
rlabs.ConfimatoryPCR_SampleDate,
rlabs.ConfirmatoryPCR_Result,
rlabs.ConfimatoryPCR_ResultDate,
rlabs.RepeatConfirmatoryPCR_SampleDate,
rlabs.RepeatConfirmatoryPCR_Result,
rlabs.RepeatConfirmatoryPCR_ResultDate,
rlabs.BaselineViralLoadSampleDate,
rlabs.BaselineViralLoadResult,
rlabs.BaselineViralLoadResultDate,
rlabs.Final_AntibodySampleDate,
rlabs.Final_AntibodyResult,
rlabs.Final_AntibodyResultDate,
NULL Dna_pcr_sample_date,
NULL Dna_pcr_contextual_status,
NULL Dna_pcr_results,
CASE WHEN ltazt.[Name]='AZT liquid BID for 12 weeks' then 'Yes' 
when ltazt.[Name]='AZT liquid BID + NVP liquid OD for 6 weeks then NVP liquid OD for 6 weeks' then 'Yes'
end as Azt_given,
CASE WHEN ltazt.[Name]='NVP liquid OD for 12 weeks' then 'Yes'
when ltazt.[Name]='AZT liquid BID + NVP liquid OD for 6 weeks then NVP liquid OD for 6 weeks' then 'Yes'
end as NVP_Given,
NULL CTX_Given,
ltazt.[Name] as  ARV_prophylaxis_received,
he.ArvProphylaxisOther as ARV_prophylaxis_Other_received,
NULL First_antibody_sample_date ,
NULL First_antibody_result,      
 NULL First_antibody_dbs_sample_code,
 NULL First_antibody_result_date,
 NULL Final_antibody_sample_date,  
 NULL Final_antibody_result,   
 NULL Final_antibody_dbs_sample_code,
NULL  Final_antibody_result_date,
NULL  Tetracycline_Eye_Ointment,
NULL Pupil,
NULL Sight,
NULL Squint,
NULL Deworming_Drug,
NULL Deworming_Dosage_Units,
heapp.AppointmentDate as [Date_of_next_appointment],
heapp.[Description] as Comments,
he.DeleteFlag as Voided,
he.CreatedBy,
he.CreateDate

  from HEIEncounter he
inner join Patient p on he.PatientId=p.Id
inner join (select pe.PatientId,pe.PatientMasterVisitId,pe.EncounterTypeId,pmv.VisitDate,ltv.ItemName as EncounterType from PatientEncounter pe
inner join PatientMasterVisit pmv on pmv.Id=pe.PatientMasterVisitId 
inner join LookupItemView ltv on ltv.ItemId=pe.EncounterTypeId and ltv.MasterName='EncounterType'
where ltv.ItemName='hei-encounter'
)pen
on pen.PatientId =he.PatientId and pen.PatientMasterVisitId=he.PatientMasterVisitId 
inner join Person per on per.Id=p.PersonId 
left join PatientVitals pvs on pvs.PatientId=he.PatientId  and pvs.PatientMasterVisitId=he.PatientMasterVisitId
left join(select hf.PatientId,hf.PatientMasterVisitId,hf.FeedingModeId,lt.[Name] as InfantFeeding,
						 CASE WHEN lt.[Name]='Not Breastfeeding' then 'No'
						 when lt.[Name] is not null  and lt.[Name] !='Not Breastfeeding' then 'Yes'
						 else null end as Feeding
						  from  HEIFeeding hf
						  left join LookupItem lt on lt.Id=hf.FeedingModeId)hf
						   on hf.PatientId=p.Id and hf.PatientMasterVisitId=he.PatientMasterVisitId
  left join(select * from (select  ps.PatientId,ps.PatientMasterVisitId,ps.ScreeningTypeId,ltv.[Name] as ScreeningType,ps.DeleteFlag,ROW_NUMBER() OVER(partition by ps.PatientId,ps.PatientMasterVisitId
  order by ps.Id desc)rownum,
lt.[Name] as ScreeningValue
 from PatientScreening ps
inner join LookupMaster ltv on ltv.Id=ps.ScreeningTypeId
inner join LookupItem lt on lt.Id=ps.ScreeningValueId
 where  ltv.[Name]='TbScreeningOutcome' and (ps.DeleteFlag is null or ps.DeleteFlag=0))ps where ps.rownum='1')tbs on tbs.PatientId=p.Id and tbs.PatientMasterVisitId=he.PatientMasterVisitId
left join(select   t.PatientId,t.PatientMasterVisitId,max(t.[&lt;2 Months]) as [Social_smile_milestone_&lt;2Months],
max(t.[2 Months]) as [Social_smile_milestone_2Months],
max(t.[3 Months]) as Head_control_milestone_3Months,
max(t.[4 Months]) as  Head_control_milestone_4Months,
max(t.[6 Months]) as Response_to_sound_milestone_6months,
max(t.[9 Months]) as Hand_extension_milestone_9months,
max(t.[12 Months]) as Sitting_milestone_12months,
max(t.[15 Months]) as Standing_milestone_15months,
max(t.[18 Months]) as Walking_milestone_18months,
max(t.[36 Months]) as Talking_milestone_36months
  from(select pmi.PatientId,pmi.PatientMasterVisitId,pmi.TypeAssessedId, lt.[Name] as MilestoneType
,pmi.StatusId,lti.[Name] as [Status],pmi.DeleteFlag ,pmi.DateAssessed from PatientMilestone pmi
inner join LookupItem lt on lt.Id=pmi.TypeAssessedId
inner join LookupItem lti on lti.Id=pmi.StatusId
where (pmi.DeleteFlag is null or pmi.DeleteFlag =0) )
m 
pivot (max(m.[Status]) for MilestoneType In ([&lt;2 Months], [2 Months]
,[3 Months],[4 Months] ,[6 Months] ,[9 Months] ,[12 Months] ,[15 Months] ,[18 Months] ,[36 Months])

)T  group by T.PatientId,T.PatientMasterVisitId)m on m.PatientId=he.PatientId
and m.PatientMasterVisitId =he.PatientMasterVisitId
left join(select r.PatientId,r.PatientMasterVisitId,r.[1st DNA PCRResult] as [1st_DNA_PCRResult] 
,CAST(r.[1st DNA PCRSampleDate] as datetime) as [1st_DNA_PCRSampleDate]
,CAST(r.[1st DNA PCRResultDate] as datetime) as  [1st_DNA_PCRResultDate]
,r.[2nd DNA PCRResult] as [2nd_DNA_PCRResult]
,CAST(r.[2nd DNA PCRSampleDate] as datetime) as [2nd_DNA_PCRSampleDate]
,CAST(r.[2nd DNA PCRResultDate] as datetime) as [2nd_DNA_PCRResultDate]
,r.[3rd DNA PCRResult] as  [3rd_DNA_PCRResult]
,CAST(r.[3rd DNA PCRSampleDate] as datetime) as [3rd_DNA_PCRSampleDate]
,CAST(r.[3rd DNA PCRResultDate] as datetime) as [3rd_DNA_PCRResultDate]
,r.[Final AntibodyResult] as [Final_AntibodyResult]
,CAST(r.[Final AntibodySampleDate] as datetime) as [Final_AntibodySampleDate],
CAST(r.[Final AntibodyResultDate] as datetime) as Final_AntibodyResultDate,
r.[Confirmatory PCR (for ?+ve)Result] as ConfirmatoryPCR_Result,
CAST(r.[Confirmatory PCR (for ?+ve)SampleDate] as datetime) as ConfimatoryPCR_SampleDate
,CAST(r.[Confirmatory PCR (for ?+ve)ResultDate] as datetime) as ConfimatoryPCR_ResultDate
,r.[Repeat confirmatory PCR (for +ve)Result] as RepeatConfirmatoryPCR_Result,
CAST(r.[Repeat confirmatory PCR (for +ve)SampleDate] as datetime) as RepeatConfirmatoryPCR_SampleDate
,CAST(r.[Repeat confirmatory PCR (for +ve)ResultDate] as datetime) as RepeatConfirmatoryPCR_ResultDate,
[Baseline Viral Load (for +ve)Result] as BaselineViralLoadResult
,CAST([Baseline Viral Load (for +ve)SampleDate] as datetime) as BaselineViralLoadSampleDate
,CAST([Baseline Viral Load (for +ve)ResultDate] as datetime) as BaselineViralLoadResultDate


 from (select heilabs.PatientId,heilabs.PatientMasterVisitId,ColumnName,ColumnValue from (select hes.PatientId,lab.PatientMasterVisitId,hes.LabOrderId,hes.HeiLabTestTypeId,ltv.ItemName,lab.SampleDate ,lab.ResultDate,COALESCE(CAST(lab.TestResults as VARCHAR),lab.TestResults1)Result from HeiLabTests hes 
inner join LookupItemView ltv on ltv.ItemId=hes.HeiLabTestTypeId  and ltv.MasterName='HeiHivTestTypes'
inner join (Select	O.Id				LabId
		,o.Ptn_Pk
		,o.PatientMasterVisitId
		,o.PatientId
		,O.LocationId
		,O.OrderedBy		OrderedByName
		,O.OrderNumber
		,o.OrderDate		OrderedByDate
		,Ot.ResultBy		ReportedByName
		,OT.ResultDate		ReportedByDate
		,O.OrderedBy		CheckedbyName
		,o.OrderDate		CheckedbyDate
		,O.PreClinicLabDate
		,LT.ParameterName	TestName
		,LT.ParameterId		TestId
		,LT.LabTestId		[Test GroupId]
		,lt.LabTestName		[Test GroupName]
		,LT.DepartmentId	LabDepartmentId
		,LT.LabDepartmentName
		,0					LabTypeId
		,'Additional Lab'	LabTypeName
		,R.ResultValue		TestResults
		,R.ResultText		TestResults1
		,R.ResultOptionId	 TestResultId
		,R.ResultOption		[Parameter Result]
		,R.Undetectable
		,R.DetectionLimit
		,R.ResultUnit
		,R.HasResult
		,V.VisitDate
		,Null				LabPeriod
		,LT.TestReferenceId
		,LT.ParameterReferenceId,
		plt.SampleDate,
	   plt.ResultDate,
	   plt.ResultOptions		
	From dbo.ord_LabOrder O
	left Join dtl_LabOrderTest OT On OT.LabOrderId = O.Id
	left Join dtl_LabOrderTestResult R On R.LabOrderTestId = OT.Id
	left join(	Select	P.Id	ParameterId
			,P.ParameterName
			,P.ReferenceId ParameterReferenceId
			,T.Id	LabTestId
			,T.Name	LabTestName
			,T.ReferenceId TestReferenceId
			,T.IsGroup
			,T.DepartmentId
			,D.LabDepartmentName
			, T.DeleteFlag TestDeleteFlag
			,T.Active TestActive
			,P.DeleteFlag ParameterDeleteFlag
	From mst_LabTestMaster T
	Inner Join Mst_LabTestParameter P On T.Id = P.LabTestId
	Left Outer Join mst_LabDepartment D On T.DepartmentId = D.LabDepartmentID)LT on LT.ParameterID=R.ParameterId
	left join PatientLabTracker plt on plt.LabOrderId=O.Id
    left Join ord_Visit V On v.Visit_Id = O.VisitId
	Where  (O.DeleteFlag is null or O.DeleteFlag =0) ) lab on lab.LabId=hes.LabOrderId)heilabs
	cross apply(
	select (heilabs.ItemName + 'Result') , CAST(heilabs.Result as varchar(max))   union all
	select (heilabs.ItemName + 'SampleDate'),CAST( heilabs.SampleDate as varchar(max))  union all
	select (heilabs.ItemName   + 'ResultDate') ,CAST(heilabs.ResultDate as varchar(max))  
	)c(ColumnName,ColumnValue)
	)t pivot(
	max(ColumnValue)
	for columnname in ([1st DNA PCRResult],[1st DNA PCRSampleDate],[1st DNA PCRResultDate],[2nd DNA PCRResult],[2nd DNA PCRSampleDate]
,[2nd DNA PCRResultDate],[3rd DNA PCRResult],[3rd DNA PCRSampleDate],[3rd DNA PCRResultDate],[Final AntibodyResult],[Final AntibodySampleDate],[Final AntibodyResultDate],
[Confirmatory PCR (for ?+ve)Result],[Confirmatory PCR (for ?+ve)SampleDate],[Confirmatory PCR (for ?+ve)ResultDate],[Repeat confirmatory PCR (for +ve)Result],
[Repeat confirmatory PCR (for +ve)SampleDate],[Repeat confirmatory PCR (for +ve)ResultDate],
[Baseline Viral Load (for +ve)Result],[Baseline Viral Load (for +ve)SampleDate],[Baseline Viral Load (for +ve)ResultDate])

)r)rlabs on rlabs.PatientId=he.PatientId and rlabs.PatientMasterVisitId=he.PatientMasterVisitId
left join LookupItem ltazt on ltazt.Id=he.ArvProphylaxisId
left join  (select * from (select pa.PatientId,pa.PatientMasterVisitId,pa.ServiceAreaId,sa.Code,pa.AppointmentDate,pa.[Description],pa.StatusDate
 as Comment,ROW_NUMBER() OVER(partition by pa.PatientId,pa.PatientMasterVisitId order by pa.Id desc)rownum from PatientAppointment pa 
 inner join ServiceArea sa on sa.Id=pa.ServiceAreaId
 where (pa.DeleteFlag is null or pa.DeleteFlag =0)
 and  sa.Code='HEI'

 )t where t.rownum='1')heapp on heapp.PatientMasterVisitId=he.PatientMasterVisitId  and heapp.PatientId=he.PatientId</sql>
    <limit>0</limit>
    <lookup/>
    <execute_each_row>N</execute_each_row>
    <variables_active>N</variables_active>
    <lazy_conversion_active>N</lazy_conversion_active>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>416</xloc>
      <yloc>96</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>load_st_hei_followup</name>
    <type>TableOutput</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>mysql_st</connection>
    <schema>migration_st</schema>
    <table>st_hei_followup</table>
    <commit>1000</commit>
    <truncate>Y</truncate>
    <ignore_errors>N</ignore_errors>
    <use_batch>Y</use_batch>
    <specify_fields>N</specify_fields>
    <partitioning_enabled>N</partitioning_enabled>
    <partitioning_field/>
    <partitioning_daily>N</partitioning_daily>
    <partitioning_monthly>Y</partitioning_monthly>
    <tablename_in_field>N</tablename_in_field>
    <tablename_field/>
    <tablename_in_table>Y</tablename_in_table>
    <return_keys>N</return_keys>
    <return_field/>
    <fields>
    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>720</xloc>
      <yloc>96</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step_error_handling>
  </step_error_handling>
  <slave-step-copy-partition-distribution>
  </slave-step-copy-partition-distribution>
  <slave_transformation>N</slave_transformation>
  <attributes/>
</transformation>
