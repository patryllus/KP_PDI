<?xml version="1.0" encoding="UTF-8"?>
<transformation>
  <info>
    <name>Transform_hiv_followup</name>
    <description/>
    <extended_description/>
    <trans_version/>
    <trans_type>Normal</trans_type>
    <trans_status>0</trans_status>
    <directory>/</directory>
    <parameters>
      <parameter>
        <name>mysql_tr</name>
        <default_value/>
        <description/>
      </parameter>
    </parameters>
    <log>
      <trans-log-table>
        <connection/>
        <schema/>
        <table/>
        <size_limit_lines/>
        <interval/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STATUS</id>
          <enabled>Y</enabled>
          <name>STATUS</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
          <subject/>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
          <subject/>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
          <subject/>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
          <subject/>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
          <subject/>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
          <subject/>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>STARTDATE</id>
          <enabled>Y</enabled>
          <name>STARTDATE</name>
        </field>
        <field>
          <id>ENDDATE</id>
          <enabled>Y</enabled>
          <name>ENDDATE</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>DEPDATE</id>
          <enabled>Y</enabled>
          <name>DEPDATE</name>
        </field>
        <field>
          <id>REPLAYDATE</id>
          <enabled>Y</enabled>
          <name>REPLAYDATE</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>Y</enabled>
          <name>LOG_FIELD</name>
        </field>
        <field>
          <id>EXECUTING_SERVER</id>
          <enabled>N</enabled>
          <name>EXECUTING_SERVER</name>
        </field>
        <field>
          <id>EXECUTING_USER</id>
          <enabled>N</enabled>
          <name>EXECUTING_USER</name>
        </field>
        <field>
          <id>CLIENT</id>
          <enabled>N</enabled>
          <name>CLIENT</name>
        </field>
      </trans-log-table>
      <perf-log-table>
        <connection/>
        <schema/>
        <table/>
        <interval/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>SEQ_NR</id>
          <enabled>Y</enabled>
          <name>SEQ_NR</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>INPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>INPUT_BUFFER_ROWS</name>
        </field>
        <field>
          <id>OUTPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>OUTPUT_BUFFER_ROWS</name>
        </field>
      </perf-log-table>
      <channel-log-table>
        <connection/>
        <schema/>
        <table/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>LOGGING_OBJECT_TYPE</id>
          <enabled>Y</enabled>
          <name>LOGGING_OBJECT_TYPE</name>
        </field>
        <field>
          <id>OBJECT_NAME</id>
          <enabled>Y</enabled>
          <name>OBJECT_NAME</name>
        </field>
        <field>
          <id>OBJECT_COPY</id>
          <enabled>Y</enabled>
          <name>OBJECT_COPY</name>
        </field>
        <field>
          <id>REPOSITORY_DIRECTORY</id>
          <enabled>Y</enabled>
          <name>REPOSITORY_DIRECTORY</name>
        </field>
        <field>
          <id>FILENAME</id>
          <enabled>Y</enabled>
          <name>FILENAME</name>
        </field>
        <field>
          <id>OBJECT_ID</id>
          <enabled>Y</enabled>
          <name>OBJECT_ID</name>
        </field>
        <field>
          <id>OBJECT_REVISION</id>
          <enabled>Y</enabled>
          <name>OBJECT_REVISION</name>
        </field>
        <field>
          <id>PARENT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>PARENT_CHANNEL_ID</name>
        </field>
        <field>
          <id>ROOT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>ROOT_CHANNEL_ID</name>
        </field>
      </channel-log-table>
      <step-log-table>
        <connection/>
        <schema/>
        <table/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>N</enabled>
          <name>LOG_FIELD</name>
        </field>
      </step-log-table>
      <metrics-log-table>
        <connection/>
        <schema/>
        <table/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>METRICS_DATE</id>
          <enabled>Y</enabled>
          <name>METRICS_DATE</name>
        </field>
        <field>
          <id>METRICS_CODE</id>
          <enabled>Y</enabled>
          <name>METRICS_CODE</name>
        </field>
        <field>
          <id>METRICS_DESCRIPTION</id>
          <enabled>Y</enabled>
          <name>METRICS_DESCRIPTION</name>
        </field>
        <field>
          <id>METRICS_SUBJECT</id>
          <enabled>Y</enabled>
          <name>METRICS_SUBJECT</name>
        </field>
        <field>
          <id>METRICS_TYPE</id>
          <enabled>Y</enabled>
          <name>METRICS_TYPE</name>
        </field>
        <field>
          <id>METRICS_VALUE</id>
          <enabled>Y</enabled>
          <name>METRICS_VALUE</name>
        </field>
      </metrics-log-table>
    </log>
    <maxdate>
      <connection/>
      <table/>
      <field/>
      <offset>0.0</offset>
      <maxdiff>0.0</maxdiff>
    </maxdate>
    <size_rowset>10000</size_rowset>
    <sleep_time_empty>50</sleep_time_empty>
    <sleep_time_full>50</sleep_time_full>
    <unique_connections>N</unique_connections>
    <feedback_shown>Y</feedback_shown>
    <feedback_size>50000</feedback_size>
    <using_thread_priorities>Y</using_thread_priorities>
    <shared_objects_file/>
    <capture_step_performance>N</capture_step_performance>
    <step_performance_capturing_delay>1000</step_performance_capturing_delay>
    <step_performance_capturing_size_limit>100</step_performance_capturing_size_limit>
    <dependencies>
    </dependencies>
    <partitionschemas>
    </partitionschemas>
    <slaveservers>
    </slaveservers>
    <clusterschemas>
    </clusterschemas>
    <created_user>-</created_user>
    <created_date>2019/12/16 16:20:34.484</created_date>
    <modified_user>-</modified_user>
    <modified_date>2019/12/16 16:20:34.484</modified_date>
    <key_for_session_key>H4sIAAAAAAAAAAMAAAAAAAAAAAA=</key_for_session_key>
    <is_key_private>N</is_key_private>
  </info>
  <notepads>
  </notepads>
  <connection>
    <name>mysql_tr</name>
    <server>localhost</server>
    <type>MYSQL</type>
    <access>JNDI</access>
    <database>mysql_tr</database>
    <port>3306</port>
    <username/>
    <password>Encrypted </password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>3306</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>STREAM_RESULTS</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <order>
  </order>
  <step>
    <name>load_tr_hiv_followup</name>
    <type>ExecSQL</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>mysql_tr</connection>
    <execute_each_row>N</execute_each_row>
    <single_statement>N</single_statement>
    <replace_variables>N</replace_variables>
    <quoteString>N</quoteString>
    <sql>-- 17. HIV Followup transformed table
DROP TABLE IF EXISTS migration_tr.tr_hiv_followup;
CREATE TABLE migration_tr.tr_hiv_followup
    select
      fup.Person_Id as Person_Id,
      fup.Patient_clinic_number,
      fup.Encounter_Date as Encounter_Date,
      fup.Encounter_ID as Encounter_ID,
      fup.Encounter_type as Encounter_type,
      (case fup.Visit_scheduled when "Yes" then 1
       when "No" then 2 else NULL end )as Visit_scheduled,
      (case fup.Visit_by when "S" then 978
       when "TS" then 161642 else NULL end )as Visit_by,
      fup.Visit_by_other as Visit_by_other,
      (case fup.Nutritional_status when "Normal" then 978
       when "Severe Acute Malnutrition" then 163302
       when "Moderate Acute Malnutrition" then 163303
       when "Overweight/Obese" then 114413 else NULL end )as Nutritional_status,
      (case fup.Population_type when "General Population" then 164928
       when "Key Population" then 164929 else NULL end) as Population_type,
      (case fup.Key_population_type when "People who Inject with Drugs" then 105 else NULL end) as Key_population_type_pwid,
      (case fup.Key_population_type  when "Men having Sex with Men" then 160578 else NULL end) as Key_population_type_msm,
      (case fup.Key_population_type when "Female Sex Worker" then 160579 else NULL end) as Key_population_type_fsw,
      (case fup.Who_stage when "Stage1" then 1204
       when "Stage2" then 1205
       when "Stage3" then 1206
       when "Stage4" then 1207 else "" end )as Who_stage,
      (case fup.Presenting_complaints
       when "Yes" then 1
       when "No" then 2  else "" end)as Presenting_complaints,
      (case fup.Has_known_allergies
       when "Yes" then 1
       when "No" then 2  else "" end)as Has_known_allergies,
      (case fup.Has_Chronic_illnesses_cormobidities
       when "Yes" then 1065
       when "No" then 1066  else "" end)as Has_Chronic_illnesses_cormobidities,
      (case fup.Has_adverse_drug_reaction
       when "Yes" then 1
       when "No" then 2  else "" end)as Has_adverse_drug_reaction,
      (case fup.Vaccinations_today when "BCG" then 886 else NULL end)as Vaccinations_today_bcg,
      (case fup.Vaccinations_today when "OPV" then 82215 when "IPV" then 82215 else NULL end)as Vaccinations_today_pv,
      (case fup.Vaccinations_today when "Penta" then 1423 else NULL end)as Vaccinations_today_penta,
      (case fup.Vaccinations_today when "Pneumococcal" then 162342 else NULL end)as Vaccinations_today_pcv,
      (case fup.Vaccinations_today when "Measles" then 36 else NULL end)as Vaccinations_today_measles,
      (case fup.Vaccinations_today when "HBV" then 782 else NULL end)as Vaccinations_today_hbv,
      (case fup.Vaccinations_today when "Flu" then 5261 else NULL end)as Vaccinations_today_flu,
      (case fup.Vaccinations_today when "Other" then 5622 else NULL end)as Vaccinations_today_other,
      Null as Vaccinations_today_other_nc,
      fup.Last_menstrual_period as Last_menstrual_period,
      (case fup.Pregnancy_status
       when "Pregnant" then 1065
       when "Not Pregnant" then 1066 else NULL end)as Pregnancy_status,
      (case fup.Wants_pregnancy
       when "Yes" then 1065
       when "No" then 1066 else NULL end)as Wants_pregnancy,
      fup.Anc_number as Anc_number,
      (case fup.Anc_profile
       when "Yes" then 1065
       when "No" then 1066 else NULL end)as Anc_profile,
      fup.Expected_delivery_date as Expected_delivery_date,
      fup.Gravida as Gravida,
      fup.Parity_term as Parity_term,
      fup.Parity_abortion as Parity_abortion,
      (case fup.Family_planning_status
       when "Family Planning" then 965
       when "No Family Planning" then 160652
       when "Wants Family Planning" then 1360 else NULL end)as Family_planning_status,
      (case fup.Ctx_adherence
       when "Good" then 159405
       when "Fair" then 163794
       when "Inadequate" then 159407
       when "Poor" then 159407 else "" end)as Ctx_adherence,
      (case fup.Ctx_dispensed
       when "Yes" then 1065
       when " No" then 1066
       when "No" then 1066 else "" end)as Ctx_dispensed,
      (case fup.Dapsone_adherence
       when "Good" then 159405
       when "Fair" then 163794
       when "Inadequate" then 159407
       when "Poor" then 159407 else "" end)as Dapsone_adherence,
      (case fup.Dapsone_dispensed
       when "Yes" then 1065
       when " No" then 1066
       when "No" then 1066 else "" end)as Dapsone_dispensed,
      (case fup.Arv_adherence
       when "Good" then 159405
       when "Fair" then 163794
       when "Inadequate" then 159407
       when "Poor" then 159407 else NULL end)as Arv_adherence,
      (case fup.Condom_provided
       when "Yes" then 1065
       when "No" then 1066 else NULL end)as Condom_provided,
      (case fup.Screened_for_substance_abuse
       when "Yes" then 1065
       when "No" then 1066 else NULL end)as Screened_for_substance_abuse,
      (case fup.Pwp_disclosure
       when "Yes" then 1065
       when "No" then 1066 else NULL end)as Pwp_disclosure,
      (case fup.Pwp_partner_tested
       when "Yes" then 1065
       when "No" then 1066 else NULL end)as Pwp_partner_tested,
      (case fup.Cacx_screening
       when "Yes" then 1065
       when "yes" then 1065
       when "No" then 1066
       when "Never" then 1090
       when "Not Applicable" then 1175 end)as Cacx_screening,
      (case fup.Screened_for_sti
       when "Yes" then 1065
       when "No" then 1066 else NULL end)as Screened_for_sti,
      (case fup.Sti_partner_notification
       when "Yes" then 1065
       when "No" then 1066 when "Never" then 1066 when "N/A" then 1175 else NULL end)as Sti_partner_notification,
      (case fup.Stability
       when "Stable" then 1
       when "Unstable" then 2 else NULL end)as Stability,
      fup.Next_appointment_date as Next_appointment_date,
      (case fup.Next_appointment_reason
       when "Follow Up" then 160523
       when "Lab Tests" then 1283
       when "Counseling" then 159382
       when "Pharmacy Refill" then 160521
       when "Treatment Preparation" then 159382
       when "ART Fast Track Referral" then 160521
       when "Other" then 5622 else NULL end)as Next_appointment_reason,
      (case fup.Differentiated_care
       when "Yes" then 164947
       when "No" then 164942 else NULL end)as Differentiated_care,
      fup.Voided as Voided,
       fup.Created_by,
       fup.Create_date                       
    FROM migration_st.st_hiv_followup fup
      LEFT JOIN migration_tr.tr_demographics dm ON dm.Person_Id = fup.Person_Id
      WHERE (fup.Encounter_Date != "" OR fup.Encounter_Date IS NOT NULL) 
      -- AND (dm.UPN != "" OR dm.UPN IS NOT NULL)
      GROUP BY fup.Person_Id, fup.Encounter_Date;

UPDATE tr_hiv_followup
SET Gravida = NULL WHERE Gravida = "null" OR Gravida = "" ;
UPDATE tr_hiv_followup
SET Parity_term = NULL WHERE Parity_term = "null" OR Parity_term = ""; 
   


</sql>
    <set_params>N</set_params>
    <insert_field/>
    <update_field/>
    <delete_field/>
    <read_field/>
    <arguments>
    </arguments>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>192</xloc>
      <yloc>80</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step_error_handling>
  </step_error_handling>
  <slave-step-copy-partition-distribution>
  </slave-step-copy-partition-distribution>
  <slave_transformation>N</slave_transformation>
  <attributes/>
</transformation>
